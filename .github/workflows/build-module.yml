name: Build AmneziaWG (kernel 6.1.99, no SDK)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      KERNEL_VERSION: "6.1.99"
      TARGET: "rockchip"
      SUBTARGET: "armv8"
      ARCH: "aarch64"
      PKGARCH: "aarch64_generic"
      TAG: "24.10.1"

    steps:
      - name: Checkout AWG source
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential bc kmod cpio flex bison libelf-dev libssl-dev zstd golang git

      - name: Download kernel-debug (kernel headers)
        run: |
          wget https://downloads.openwrt.org/releases/${TAG}/targets/${TARGET}/${SUBTARGET}/kernel-debug.tar.zst
          mkdir kernel
          tar --zstd -xf kernel-debug.tar.zst -C kernel

      - name: Prepare kernel headers
        run: |
          mkdir -p kernel_build
          cp -r kernel/usr/src/linux-${KERNEL_VERSION} kernel_build/linux
          cd kernel_build/linux
          make olddefconfig

      - name: Build amneziawg kernel module
        run: |
          mkdir -p build
          cd build
          git clone https://github.com/amnezia-vpn/amneziawg-linux.git
          cd amneziawg-linux/src
          make -C ../../kernel_build/linux M=$(pwd) modules

      - name: Build amneziawg-tools
        run: |
          mkdir -p tools
          cd tools
          git clone https://github.com/amnezia-vpn/amneziawg-tools.git
          cd amneziawg-tools
          go build -o amneziawg

      - name: Build luci-proto-amneziawg
        run: |
          mkdir -p luci
          cd luci
          git clone https://github.com/amnezia-vpn/luci-proto-amneziawg.git

      - name: Build luci-i18n-amneziawg-ru
        run: |
          mkdir -p luci-i18n
          cd luci-i18n
          git clone https://github.com/amnezia-vpn/luci-i18n-amneziawg-ru.git

      - name: Package .ipk files
        run: |
          mkdir -p out

          # kmod
          mkdir -p ipk-kmod/CONTROL
          cat <<EOF > ipk-kmod/CONTROL/control
          Package: kmod-amneziawg
          Version: 1-${KERNEL_VERSION}
          Architecture: ${PKGARCH}
          Description: AmneziaWG kernel module
          Depends: kernel (= ${KERNEL_VERSION}-1)
          EOF
          mkdir -p ipk-kmod/lib/modules/${KERNEL_VERSION}
          cp build/amneziawg-linux/src/amneziawg.ko ipk-kmod/lib/modules/${KERNEL_VERSION}/
          tar -czf out/kmod-amneziawg_${KERNEL_VERSION}.ipk -C ipk-kmod .

          # tools
          mkdir -p ipk-tools/usr/bin
          mkdir -p ipk-tools/CONTROL
          cat <<EOF > ipk-tools/CONTROL/control
          Package: amneziawg-tools
          Version: 1
          Architecture: ${PKGARCH}
          Description: AmneziaWG tools
          EOF
          cp tools/amneziawg-tools/amneziawg ipk-tools/usr/bin/
          tar -
